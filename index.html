<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CQ4D3VQ3L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1CQ4D3VQ3L');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO & Metadata -->
    <title>Emoji Mosaic | Convert Images to Emoji Art</title>
    <meta name="description" content="Instantly convert any photo into a stunning, high-resolution emoji mosaic. A browser-based, privacy-focused image editor featuring real-time styling, custom resolutions, and massive emoji variety.">
    <meta name="keywords" content="emoji mosaic, image to emoji, photo to emoji, emoji art generator, browser based image editor, chris pirillo, client side processing, privacy focused image tool, spatial workspace">
    <meta name="author" content="Chris Pirillo">
    <link rel="canonical" href="https://pirillo.com/arcade/emoji-mosaic.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://pirillo.com/arcade/emoji-mosaic.html">
    <meta property="og:title" content="Emoji Mosaic | Spatial Workspace">
    <meta property="og:description" content="Turn your images into detailed emoji mosaics instantly in your browser. No uploads, total privacy.">
    <meta property="og:image" content="https://pirillo.com/arcade/images/emoji-mosaic.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://pirillo.com/arcade/emoji-mosaic.html">
    <meta name="twitter:title" content="Emoji Mosaic | Spatial Workspace">
    <meta name="twitter:description" content="Turn your images into detailed emoji mosaics instantly in your browser. No uploads, total privacy.">
    <meta name="twitter:image" content="https://pirillo.com/arcade/images/emoji-mosaic.png">
    <meta name="twitter:creator" content="@ChrisPirillo">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Emoji Mosaic",
      "url": "https://pirillo.com/arcade/emoji-mosaic.html",
      "image": "https://pirillo.com/arcade/images/emoji-mosaic.png",
      "description": "A client-side web application that transforms standard images into high-resolution mosaics composed entirely of emojis.",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "Any",
      "author": {
        "@type": "Person",
        "name": "Chris Pirillo",
        "url": "https://pirillo.com"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>

    <!-- Resource Hints -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Typography & Core Variables */
        :root {
            --bg-obsidian: #09090b;
            --glass-panel: rgba(24, 24, 27, 0.90);
            --glass-border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            --font-mono: 'SF Mono', 'Consolas', 'Menlo', monospace;
        }

        body {
            background-color: var(--bg-obsidian);
            background-image: radial-gradient(circle at 50% 50%, #18181b 0%, #000000 100%);
            color: #e4e4e7;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-panel);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Inputs & Sliders */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
            height: 4px;
            border-radius: 2px;
            background: #3f3f46;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e4e4e7;
            cursor: pointer;
            border: 2px solid var(--bg-obsidian);
            transition: transform 0.1s;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: var(--accent);
        }

        /* Color Picker Reset */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            padding: 0;
            background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid var(--glass-border);
            border-radius: 4px;
        }

        .mono-value {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: #a1a1aa;
        }

        /* Status Capsule Animation */
        .status-dot {
            width: 6px; height: 6px; border-radius: 50%;
            background-color: #22c55e;
            box-shadow: 0 0 10px #22c55e;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .status-dot.busy {
            background-color: #eab308;
            box-shadow: 0 0 10px #eab308;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Scanline Animation */
        .scanline {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            opacity: 0; pointer-events: none; z-index: 50;
            transition: opacity 0.2s;
        }
        .scanning {
            opacity: 1;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Transparency Checkerboard Pattern */
        .transparent-bg {
            background-image:
                linear-gradient(45deg, #1f1f23 25%, transparent 25%),
                linear-gradient(-45deg, #1f1f23 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1f1f23 75%),
                linear-gradient(-45deg, transparent 75%, #1f1f23 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #18181b; 
        }

        /* Cursor States */
        body.is-panning-ws { cursor: grabbing !important; }
        .canvas-interacting { cursor: grabbing !important; }
        #canvasWrapper { cursor: move; /* Default to move/crop */ }
        body.space-held #canvasWrapper { cursor: grab; }

        /* Help Modal */
        #helpModal {
            transform: scale(0.95); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #helpModal.active,
        #helpModal.hover-active {
            transform: scale(1); opacity: 1; pointer-events: auto;
        }

        /* ABSOLUTE CENTERING FIX:
           The wrapper is now absolutely positioned in the center of the viewport.
           This breaks it out of the flex flow, preventing the parent from clipping 
           it when the canvas resolution exceeds the window size.
        */
        #canvasWrapper {
            position: absolute;
            left: 50%;
            top: 50%;
            transform-origin: center center;
            /* Start centered and hidden */
            display: none;
        }

        /* Ensure canvases have no layout constraints */
        #canvasWrapper canvas {
            display: block;
            width: auto;
            height: auto;
            max-width: none;
            max-height: none;
        }
        #bgCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        /* Mobile Slide Utility */
        .translate-y-0 { transform: translateY(0) !important; }

    </style>
</head>
<body class="overflow-hidden bg-zinc-950" oncontextmenu="return false;">

    <!-- Hidden Native File Input -->
    <input type="file" id="fileInput" class="hidden" accept="image/*">

    <!-- Status Capsule (Upper Left) -->
    <div class="fixed top-6 left-6 z-50 glass-panel rounded-full px-4 py-2 flex items-center gap-3 select-none pointer-events-none transition-all duration-200" id="statusCapsule">
        <div id="statusDot" class="status-dot"></div>
        <span id="statusText" class="text-[10px] font-medium text-zinc-300 tracking-wide font-mono uppercase whitespace-nowrap min-w-[60px]">Ready</span>
    </div>

    <!-- Help Trigger (Lower Left) -->
    <button id="helpTrigger" aria-label="Help and Instructions" class="fixed bottom-6 left-6 z-50 glass-panel rounded-full w-10 h-10 flex items-center justify-center text-zinc-400 hover:text-white hover:scale-105 transition-all focus:outline-none shadow-lg">
        <span class="font-bold text-lg">?</span>
    </button>
    
    <!-- Mobile Settings Toggle (Lower Right - Visible only on Mobile) -->
    <button id="mobileSettingsToggle" aria-label="Open Settings" class="md:hidden fixed bottom-6 right-6 z-50 glass-panel rounded-full w-12 h-12 flex items-center justify-center text-zinc-400 hover:text-white transition-all shadow-lg active:scale-95">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed bottom-20 left-6 z-50 glass-panel rounded-2xl p-6 w-auto shadow-2xl origin-bottom-left">
        <h3 class="text-sm font-bold text-white mb-3 uppercase tracking-wider whitespace-nowrap">Spatial Controls</h3>
        <ul class="text-xs text-zinc-300 space-y-2.5 whitespace-nowrap">
            <li class="flex items-start gap-2">
                <span><strong>Drag Image</strong> to Pan / Crop within the frame.</span>
            </li>
            <li class="flex items-start gap-2">
                <span><strong>Scroll Wheel</strong> to Zoom in/out on the image.</span>
            </li>
            <li class="flex items-start gap-2">
                <span>Hold <strong>Space + Drag</strong> to move the entire workspace.</span>
            </li>
             <li class="flex items-start gap-2">
                <span><strong>Drop File</strong> anywhere to load a new image.</span>
            </li>
        </ul>
    </div>

    <!-- HUD Layer (Sidebar) -->
    <!-- 
      Responsive Layout Update:
      Mobile: Top-Half Drawer, Hidden by Default (-translate-y-[150%])
      Desktop: Fixed Sidebar on Right (translate-y-0)
    -->
    <aside class="glass-panel fixed z-40 flex flex-col overflow-hidden transition-transform duration-300 transform
                  top-0 left-0 right-0 h-[50vh] w-full rounded-b-2xl border-b border-white/10 -translate-y-[150%] shadow-2xl
                  md:translate-y-0 md:top-6 md:bottom-6 md:right-6 md:w-80 md:h-auto md:left-auto md:rounded-2xl md:border md:border-white/10 md:shadow-xl" 
           id="sidebar">
        
        <!-- Scrollable Controls -->
        <div class="flex-1 overflow-y-auto p-6 space-y-8 pt-8">
            
            <!-- Composition -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wider">Composition</label>
                </div>

                <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label class="text-[10px] text-zinc-400 mb-1 block">Aspect Ratio</label>
                        <select id="aspectRatio" class="w-full bg-black/20 border border-zinc-700 rounded text-xs text-zinc-300 py-1.5 px-2 focus:border-indigo-500 outline-none">
                            <option value="0">Original</option>
                            <optgroup label="Standard">
                                <option value="1">Square (1:1)</option>
                                <option value="1.333">Photo (4:3)</option>
                                <option value="1.5">Camera (3:2)</option>
                            </optgroup>
                            <optgroup label="Desktop">
                                <option value="1.777">HD (16:9)</option>
                                <option value="1.6">Wide (16:10)</option>
                                <option value="2.333">Ultra (21:9)</option>
                            </optgroup>
                            <optgroup label="Mobile">
                                <option value="0.5625">Story (9:16)</option>
                                <option value="0.4615">Phone (9:19.5)</option>
                                <option value="0.8">Portrait (4:5)</option>
                            </optgroup>
                        </select>
                     </div>
                     <div>
                        <label class="text-[10px] text-zinc-400 mb-1 block flex justify-between">
                            Zoom 
                            <span id="zoomDisplay" class="text-white">1.0x</span>
                        </label>
                        <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1.0" class="w-full">
                     </div>
                </div>
            </div>

            <!-- Style -->
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wider">Style Processing</label>
                    <button id="resetStyleBtn" aria-label="Reset Styles" class="text-zinc-500 hover:text-white transition-colors" title="Reset Colors">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
                
                <div class="space-y-1">
                    <div class="flex justify-between">
                        <span class="text-xs text-zinc-300">Preset</span>
                    </div>
                    <select id="filterPreset" class="w-full bg-black/20 border border-zinc-700 rounded text-xs text-zinc-300 py-1.5 px-2 focus:border-indigo-500 outline-none">
                        <option value="none">Normal</option>
                        <option value="grayscale">Grayscale (B&W)</option>
                        <option value="sepia">Sepia</option>
                        <option value="invert">Invert</option>
                        <option value="high_contrast">High Contrast</option>
                        <option value="low_contrast">Low Contrast</option>
                        <option value="vivid">Vivid</option>
                        <option value="muted">Muted</option>
                        <option value="deepfry">Deep Fry</option>
                        <option value="polaroid">Polaroid</option>
                        <option value="kodak">Kodachrome</option>
                        <option value="vintage">Vintage</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="noir">Noir</option>
                        <option value="1977">1977</option>
                        <option value="willow">Willow</option>
                        <option value="lofi">Lo-Fi</option>
                        <option value="xpro2">X-Pro II</option>
                        <option value="inkwell">Inkwell</option>
                        <option value="nashville">Nashville</option>
                        <option value="toaster">Toaster</option>
                        <option value="gotham">Gotham</option>
                    </select>
                </div>

                <div class="space-y-3 pt-2">
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Contrast</span>
                            <span class="mono-value" id="contrastVal">100%</span>
                        </div>
                        <input type="range" id="contrast" min="0" max="300" value="100" class="w-full">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Brightness</span>
                            <span class="mono-value" id="brightnessVal">100%</span>
                        </div>
                        <input type="range" id="brightness" min="0" max="300" value="100" class="w-full">
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Saturation</span>
                            <span class="mono-value" id="saturationVal">100%</span>
                        </div>
                        <input type="range" id="saturation" min="0" max="300" value="100" class="w-full">
                    </div>
                </div>
            </div>

            <!-- Mosaic Engine -->
            <div class="space-y-4">
                <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wider">Mosaic Engine</label>
                
                <div class="space-y-3">
                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Cell Size</span>
                            <span class="mono-value" id="cellSizeVal">12px</span>
                        </div>
                        <input type="range" id="cellSize" min="4" max="64" value="12" class="w-full">
                    </div>

                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Spacing (Overlap)</span>
                            <span class="mono-value" id="spacingVal">0px</span>
                        </div>
                        <input type="range" id="spacing" min="-10" max="20" value="0" step="1" class="w-full">
                    </div>

                    <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Chaos</span>
                            <span class="mono-value" id="chaosVal">0</span>
                        </div>
                        <input type="range" id="chaos" min="0" max="100" value="0" class="w-full">
                    </div>

                     <div class="space-y-1">
                        <div class="flex justify-between">
                            <span class="text-xs text-zinc-300">Resolution (Width)</span>
                            <span class="mono-value" id="resolutionVal">1920px</span>
                        </div>
                        <input type="range" id="resolution" min="500" max="4000" value="1920" step="100" class="w-full">
                    </div>
                </div>
            </div>

             <!-- View Controls -->
             <div class="space-y-4">
                <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wider">View</label>
                
                <!-- Background Controls -->
                <div class="flex items-center justify-between bg-black/20 p-2 rounded-lg">
                    <div class="flex items-center gap-2">
                         <input type="checkbox" id="transparentToggle" class="w-4 h-4 rounded border-zinc-600 bg-zinc-700 text-indigo-600 focus:ring-indigo-500">
                         <span class="text-xs text-zinc-300">Transparent</span>
                    </div>
                    <div class="flex items-center gap-2" id="colorPickerContainer">
                        <span class="text-[10px] text-zinc-500 uppercase">Fill</span>
                        <input type="color" id="bgColorPicker" value="#000000" title="Choose Background Color">
                    </div>
                </div>

                <div class="flex items-center justify-between bg-black/20 p-2 rounded-lg">
                    <span class="text-xs text-zinc-300">Onion Skin (Source)</span>
                    <button id="onionToggle" aria-label="Toggle Onion Skin" class="w-10 h-6 bg-zinc-700 rounded-full relative transition-colors focus:outline-none">
                        <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform" id="onionKnob"></div>
                    </button>
                </div>
            </div>

        </div>

        <!-- Footer Action -->
        <div class="p-6 border-t border-white/5 bg-white/5">
            <button id="downloadBtn" aria-label="Download PNG" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 rounded-lg shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center gap-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                <span>Download PNG</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </aside>

    <!-- Stage (Main Viewport) -->
    <main class="fixed inset-0 z-10 select-none overflow-hidden" id="stage">
        <!-- Canvas Container -->
        <div id="canvasWrapper" class="relative shadow-2xl transition-shadow duration-200">
            <div id="scanline" class="scanline"></div>
            <!-- Layers -->
            <canvas id="bgCanvas" class="transition-opacity duration-200"></canvas>
            <canvas id="emojiCanvas" class="relative block transition-opacity duration-200"></canvas>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-zinc-500 transition-opacity duration-300 cursor-pointer hover:text-zinc-400 group">
            <h1 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-zinc-600 mb-6 drop-shadow-2xl">Emoji Mosaic</h1>
            <div class="bg-white/5 border border-white/10 rounded-full px-8 py-4 backdrop-blur-md shadow-2xl flex items-center gap-4 animate-pulse group-hover:scale-105 transition-transform">
                <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span class="text-zinc-300 font-medium tracking-wide">Drop Image or Click to Upload</span>
            </div>
        </div>
    </main>

    <!-- Loading Overlay for Initial Emoji Processing -->
    <div id="loadingOverlay" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="text-center space-y-4">
            <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto"></div>
            <h2 class="text-white font-medium text-xl">Initializing Spatial Engine</h2>
            <p class="text-zinc-500 text-sm">Generating 4200+ Emoji Variations...</p>
        </div>
    </div>

    <!-- Hidden Scripts -->
    <script>
        /**
         * EMOJI MOSAIC SPATIAL
         * Version: 3.2 - Complete ISO Flag Set
         * Features: Massive Skin Tone Generation, Kanji Filtering, 250+ Flags
         */

        const RAW_EMOJI_BASE = [
            // SMILEYS & PEOPLE
            'ðŸ˜€','ðŸ˜ƒ','ðŸ˜„','ðŸ˜','ðŸ˜†','ðŸ˜…','ðŸ¤£','ðŸ˜‚','ðŸ™‚','ðŸ™ƒ','ðŸ« ','ðŸ˜‰','ðŸ˜Š','ðŸ˜‡','ðŸ¥°','ðŸ˜','ðŸ¤©','ðŸ˜˜','ðŸ˜—','â˜ºï¸','ðŸ˜š','ðŸ˜™','ðŸ¥²','ðŸ˜‹','ðŸ˜›','ðŸ˜œ','ðŸ¤ª','ðŸ˜','ðŸ¤‘','ðŸ¤—','ðŸ¤­','ðŸ«¢','ðŸ«£','ðŸ¤«','ðŸ¤”','ðŸ«¡','ðŸ¤','ðŸ¤¨','ðŸ˜','ðŸ˜‘','ðŸ˜¶','ðŸ«¥','ðŸ˜','ðŸ˜’','ðŸ™„','ðŸ˜¬','ðŸ˜®â€ðŸ’¨','ðŸ¤¥','ðŸ«¨','ðŸ˜Œ','ðŸ˜”','ðŸ˜ª','ðŸ¤¤','ðŸ˜´','ðŸ˜·','ðŸ¤’','ðŸ¤•','ðŸ¤¢','ðŸ¤®','ðŸ¤§','ðŸ¥µ','ðŸ¥¶','ðŸ¥´','ðŸ˜µ','ðŸ˜µâ€ðŸ’«','ðŸ¤¯','ðŸ¤ ','ðŸ¥³','ðŸ¥¸','ðŸ˜Ž','ðŸ¤“','ðŸ§','ðŸ˜•','ðŸ«¤','ðŸ˜Ÿ','ðŸ™','â˜¹ï¸','ðŸ˜®','ðŸ˜¯','ðŸ˜²','ðŸ˜³','ðŸ¥º','ðŸ¥¹','ðŸ˜¦','ðŸ˜§','ðŸ˜¨','ðŸ˜°','ðŸ˜¥','ðŸ˜¢','ðŸ˜­','ðŸ˜±','ðŸ˜–','ðŸ˜£','ðŸ˜ž','ðŸ˜“','ðŸ˜©','ðŸ˜«','ðŸ¥±','ðŸ˜¤','ðŸ˜¡','ðŸ˜ ','ðŸ¤¬','ðŸ˜ˆ','ðŸ‘¿','ðŸ’€','â˜ ï¸','ðŸ’©','ðŸ¤¡','ðŸ‘¹','ðŸ‘º','ðŸ‘»','ðŸ‘½','ðŸ‘¾','ðŸ¤–','ðŸ˜º','ðŸ˜¸','ðŸ˜¹','ðŸ˜»','ðŸ˜¼','ðŸ˜½','ðŸ™€','ðŸ˜¿','ðŸ˜¾',
            // BODY & EMOTION
            'ðŸ’‹','ðŸ’Œ','ðŸ’˜','ðŸ’','ðŸ’–','ðŸ’—','ðŸ’“','ðŸ’ž','ðŸ’•','ðŸ’Ÿ','â£ï¸','ðŸ’”','â¤ï¸','ðŸ§¡','ðŸ’›','ðŸ’š','ðŸ’™','ðŸ’œ','ðŸ¤Ž','ðŸ–¤','ðŸ¤','ðŸ’¯','ðŸ’¢','ðŸ’¥','ðŸ’«','ðŸ’¦','ðŸ’¨','ðŸ•³ï¸','ðŸ’£','ðŸ’¬','ðŸ‘ï¸â€ðŸ—¨ï¸','ðŸ—¨ï¸','ðŸ—¯ï¸','ðŸ’­','ðŸ’¤',
            // ANIMALS & NATURE
            'ðŸµ','ðŸ’','ðŸ¦','ðŸ¦§','ðŸ¶','ðŸ•','ðŸ¦®','ðŸ•â€ðŸ¦º','ðŸ©','ðŸº','ðŸ¦Š','ðŸ¦','ðŸ±','ðŸˆ','ðŸˆâ€â¬›','ðŸ¦','ðŸ¯','ðŸ…','ðŸ†','ðŸ´','ðŸŽ','ðŸ¦„','ðŸ¦“','ðŸ¦Œ','ðŸ¦¬','ðŸ®','ðŸ‚','ðŸ„','ðŸ·','ðŸ–','ðŸ—','ðŸ½','ðŸ','ðŸ‘','ðŸ','ðŸª','ðŸ«','ðŸ¦™','ðŸ¦’','ðŸ˜','ðŸ¦£','ðŸ¦','ðŸ¦›','ðŸ­','ðŸ','ðŸ€','ðŸ¹','ðŸ°','ðŸ‡','ðŸ¿ï¸','ðŸ¦«','ðŸ¦”','ðŸ¦‡','ðŸ»','ðŸ»â€â„ï¸','ðŸ¨','ðŸ¼','ðŸ¦¥','ðŸ¦¦','ðŸ¦¨','ðŸ¦˜','ðŸ¦¡','ðŸ¾','ðŸ¦ƒ','ðŸ”','ðŸ“','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¦','ðŸ§','ðŸ•Šï¸','ðŸ¦…','ðŸ¦†','ðŸ¦¢','ðŸ¦‰','ðŸ¦¤','ðŸª¶','ðŸ¦©','ðŸ¦š','ðŸ¦œ','ðŸ¸','ðŸŠ','ðŸ¢','ðŸ¦Ž','ðŸ','ðŸ²','ðŸ‰','ðŸ¦•','ðŸ¦–','ðŸ³','ðŸ‹','ðŸ¬','ðŸ¦­','ðŸŸ','ðŸ ','ðŸ¡','ðŸ¦ˆ','ðŸ™','ðŸš','ðŸª¸','ðŸŒ','ðŸ¦‹','ðŸ›','ðŸœ','ðŸ','ðŸª²','ðŸž','ðŸ¦—','ðŸª³','ðŸ•·ï¸','ðŸ•¸ï¸','ðŸ¦‚','ðŸ¦Ÿ','ðŸª°','ðŸª±','ðŸ¦ ','ðŸ’','ðŸŒ¸','ðŸ’®','ðŸµï¸','ðŸŒ¹','ðŸ¥€','ðŸŒº','ðŸŒ»','ðŸŒ¼','ðŸŒ·','ðŸŒ±','ðŸª´','ðŸŒ²','ðŸŒ³','ðŸŒ´','ðŸŒµ','ðŸŒ¾','ðŸŒ¿','â˜˜ï¸','ðŸ€','ðŸ','ðŸ‚','ðŸƒ','ðŸª¹','ðŸªº',
            // FOOD & DRINK
            'ðŸ‡','ðŸˆ','ðŸ‰','ðŸŠ','ðŸ‹','ðŸŒ','ðŸ','ðŸ¥­','ðŸŽ','ðŸ','ðŸ','ðŸ‘','ðŸ’','ðŸ“','ðŸ«','ðŸ¥','ðŸ…','ðŸ«’','ðŸ¥¥','ðŸ¥‘','ðŸ†','ðŸ¥”','ðŸ¥•','ðŸŒ½','ðŸŒ¶ï¸','ðŸ«‘','ðŸ¥’','ðŸ¥¬','ðŸ¥¦','ðŸ§„','ðŸ§…','ðŸ„','ðŸ¥œ','ðŸ«˜','ðŸŒ°','ðŸž','ðŸ¥','ðŸ¥–','ðŸ«“','ðŸ¥¨','ðŸ¥¯','ðŸ¥ž','ðŸ§‡','ðŸ§€','ðŸ–','ðŸ—','ðŸ¥©','ðŸ¥“','ðŸ”','ðŸŸ','ðŸ•','ðŸŒ­','ðŸ¥ª','ðŸŒ®','ðŸŒ¯','ðŸ«”','ðŸ¥™','ðŸ§†','ðŸ¥š','ðŸ³','ðŸ¥˜','ðŸ²','ðŸ«•','ðŸ¥£','ðŸ¥—','ðŸ¿','ðŸ§ˆ','ðŸ§‚','ðŸ¥«','ðŸ±','ðŸ˜','ðŸ™','ðŸš','ðŸ›','ðŸœ','ðŸ','ðŸ ','ðŸ¢','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¥®','ðŸ¡','ðŸ¥Ÿ','ðŸ¥ ','ðŸ¥¡','ðŸ¦€','ðŸ¦ž','ðŸ¦','ðŸ¦‘','ðŸ¦ª','ðŸ¦','ðŸ§','ðŸ¨','ðŸ©','ðŸª','ðŸŽ‚','ðŸ°','ðŸ§','ðŸ¥§','ðŸ«','ðŸ¬','ðŸ­','ðŸ®','ðŸ¯','ðŸ¼','ðŸ¥›','â˜•','ðŸ«–','ðŸµ','ðŸ¶','ðŸ¾','ðŸ·','ðŸ¸','ðŸ¹','ðŸº','ðŸ»','ðŸ¥‚','ðŸ¥ƒ','ðŸ¥¤','ðŸ§‹','ðŸ§ƒ','ðŸ§‰','ðŸ§Š','ðŸ¥¢','ðŸ½ï¸','ðŸ´','ðŸ¥„',
            // TRAVEL & PLACES
            'ðŸŒ','ðŸŒŽ','ðŸŒ','ðŸŒ','ðŸ—ºï¸','ðŸ—¾','ðŸ§­','ðŸ”ï¸','â›°ï¸','ðŸŒ‹','ðŸ—»','ðŸ•ï¸','ðŸ–ï¸','ðŸœï¸','ðŸï¸','ðŸžï¸','ðŸŸï¸','ðŸ›ï¸','ðŸ—ï¸','ðŸ§±','ðŸª¨','ðŸªµ','ðŸ›–','ðŸ˜ï¸','ðŸšï¸','ðŸ ','ðŸ¡','ðŸ¢','ðŸ£','ðŸ¤','ðŸ¥','ðŸ¦','ðŸ¨','ðŸ©','ðŸª','ðŸ«','ðŸ¬','ðŸ­','ðŸ¯','ðŸ°','ðŸ’’','ðŸ—¼','ðŸ—½','â›ª','ðŸ•Œ','ðŸ›•','ðŸ•','â›©ï¸','ðŸ•‹','â›²','â›º','ðŸŒ','ðŸŒƒ','ðŸ™ï¸','ðŸŒ„','ðŸŒ…','ðŸŒ†','ðŸŒ‡','ðŸŒ‰','â™¨ï¸','ðŸŽ ','ðŸŽ¡','ðŸŽ¢','ðŸ’ˆ','ðŸŽª','ðŸš‚','ðŸšƒ','ðŸš„','ðŸš…','ðŸš†','ðŸš‡','ðŸšˆ','ðŸš‰','ðŸšŠ','ðŸš','ðŸšž','ðŸš‹','ðŸšŒ','ðŸš','ðŸšŽ','ðŸš','ðŸš‘','ðŸš’','ðŸš“','ðŸš”','ðŸš•','ðŸš–','ðŸš—','ðŸš˜','ðŸš™','ðŸ›»','ðŸšš','ðŸš›','ðŸšœ','ðŸŽï¸','ðŸï¸','ðŸ›µ','ðŸ¦½','ðŸ¦¼','ðŸ›º','ðŸš²','ðŸ›´','ðŸ›¹','ðŸ›¼','ðŸš','ðŸ›£ï¸','ðŸ›¤ï¸','ðŸ›¢ï¸','â›½','ðŸš¨','ðŸš¥','ðŸš¦','ðŸ›‘','ðŸš§','âš“','â›µ','ðŸ›¶','ðŸš¤','ðŸ›³ï¸','â›´ï¸','ðŸ›¥ï¸','ðŸš¢','âœˆï¸','ðŸ›©ï¸','ðŸ›«','ðŸ›¬','ðŸª‚','ðŸ’º','ðŸš','ðŸšŸ','ðŸš ','ðŸš¡','ðŸ›°ï¸','ðŸš€','ðŸ›¸','ðŸ›Žï¸','ðŸ§³','âŒ›','â³','âŒš','â°','â±ï¸','â²ï¸','ðŸ•°ï¸','ðŸ•›','ðŸ•§','ðŸ•','ðŸ•œ','ðŸ•‘','ðŸ•','ðŸ•’','ðŸ•ž','ðŸ•“','ðŸ•Ÿ','ðŸ•”','ðŸ• ','ðŸ••','ðŸ•¡','ðŸ•–','ðŸ•¢','ðŸ•—','ðŸ•£','ðŸ•˜','ðŸ•¤','ðŸ•™','ðŸ•¥','ðŸ•š','ðŸ•¦','ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜','ðŸŒ™','ðŸŒš','ðŸŒ›','ðŸŒœ','ðŸŒ¡ï¸','â˜€ï¸','ðŸŒ','ðŸŒž','ðŸª','â­','ðŸŒŸ','ðŸŒ ','ðŸŒŒ','â˜ï¸','â›…','â›ˆï¸','ðŸŒ¤ï¸','ðŸŒ¥ï¸','ðŸŒ¦ï¸','ðŸŒ§ï¸','ðŸŒ¨ï¸','ðŸŒ©ï¸','ðŸŒªï¸','ðŸŒ«ï¸','ðŸŒ¬ï¸','ðŸŒ€','ðŸŒˆ','ðŸŒ‚','â˜‚ï¸','â˜”','â›±ï¸','âš¡','â„ï¸','â˜ƒï¸','â›„','â˜„ï¸','ðŸ”¥','ðŸ’§','ðŸŒŠ',
            // OBJECTS
            'ðŸŽƒ','ðŸŽ„','ðŸŽ†','ðŸŽ‡','ðŸ§¨','âœ¨','ðŸŽˆ','ðŸŽ‰','ðŸŽŠ','ðŸŽ‹','ðŸŽ','ðŸŽŽ','ðŸŽ','ðŸŽ','ðŸŽ‘','ðŸ§§','ðŸŽ€','ðŸŽ','ðŸŽ—ï¸','ðŸŽŸï¸','ðŸŽ«','ðŸŽ–ï¸','ðŸ†','ðŸ…','ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','âš½','âš¾','ðŸ¥Ž','ðŸ€','ðŸ','ðŸˆ','ðŸ‰','ðŸŽ¾','ðŸ¥','ðŸŽ³','ðŸ','ðŸ‘','ðŸ’','ðŸ¥','ðŸ“','ðŸ¸','ðŸ¥Š','ðŸ¥‹','ðŸ¥…','â›³','â›¸ï¸','ðŸŽ£','ðŸ¤¿','ðŸŽ½','ðŸŽ¿','ðŸ›·','ðŸ¥Œ','ðŸŽ¯','ðŸª€','ðŸª','ðŸŽ±','ðŸ”®','ðŸª„','ðŸ§¿','ðŸŽ®','ðŸ•¹ï¸','ðŸŽ°','ðŸŽ²','ðŸ§©','ðŸ§¸','ðŸª…','ðŸª©','ðŸª†','â™ ï¸','â™¥ï¸','â™¦ï¸','â™£ï¸','â™Ÿï¸','ðŸƒ','ðŸ€„','ðŸŽ´','ðŸŽ­','ðŸ–¼ï¸','ðŸŽ¨','ðŸ§µ','ðŸª¡','ðŸ§¶','ðŸª¢','ðŸ‘“','ðŸ•¶ï¸','ðŸ¥½','ðŸ¥¼','ðŸ¦º','ðŸ‘”','ðŸ‘•','ðŸ‘–','ðŸ§£','ðŸ§¤','ðŸ§¥','ðŸ§¦','ðŸ‘—','ðŸ‘˜','ðŸ¥»','ðŸ©±','ðŸ©²','ðŸ©³','ðŸ‘™','ðŸ‘š','ðŸ‘›','ðŸ‘œ','ðŸ‘','ðŸ›ï¸','ðŸŽ’','ðŸ©´','ðŸ‘ž','ðŸ‘Ÿ','ðŸ¥¾','ðŸ¥¿','ðŸ‘ ','ðŸ‘¡','ðŸ©°','ðŸ‘¢','ðŸ‘‘','ðŸ‘’','ðŸŽ©','ðŸŽ“','ðŸ§¢','ðŸª–','â›‘ï¸','ðŸ“¿','ðŸ’„','ðŸ’','ðŸ’Ž','ðŸ”‡','ðŸ”ˆ','ðŸ”‰','ðŸ”Š','ðŸ“¢','ðŸ“£','ðŸ“¯','ðŸ””','ðŸ”•','ðŸŽ¼','ðŸŽµ','ðŸŽ¶','ðŸŽ™ï¸','ðŸŽšï¸','ðŸŽ›ï¸','ðŸŽ¤','ðŸŽ§','ðŸ“»','ðŸŽ·','ðŸª—','ðŸŽ¸','ðŸŽ¹','ðŸŽº','ðŸŽ»','ðŸª•','ðŸ¥','ðŸª˜','ðŸ“±','ðŸ“²','â˜Žï¸','ðŸ“ž','ðŸ“Ÿ','ðŸ“ ','ðŸ”‹','ðŸ”Œ','ðŸ’»','ðŸ–¥ï¸','ðŸ–¨ï¸','âŒ¨ï¸','ðŸ–±ï¸','ðŸ–²ï¸','ðŸ’½','ðŸ’¾','ðŸ’¿','ðŸ“€','ðŸ§®','ðŸŽ¥','ðŸŽžï¸','ðŸ“½ï¸','ðŸŽ¬','ðŸ“º','ðŸ“·','ðŸ“¸','ðŸ“¹','ðŸ“¼','ðŸ”','ðŸ”Ž','ðŸ•¯ï¸','ðŸ’¡','ðŸ”¦','ðŸ®','ðŸª”','ðŸ“”','ðŸ“•','ðŸ“–','ðŸ“—','ðŸ“˜','ðŸ“™','ðŸ“š','ðŸ““','ðŸ“’','ðŸ“ƒ','ðŸ“œ','ðŸ“„','ðŸ“°','ðŸ—žï¸','ðŸ“‘','ðŸ”–','ðŸ·ï¸','ðŸ’°','ðŸª™','ðŸ’´','ðŸ’µ','ðŸ’¶','ðŸ’·','ðŸ’¸','ðŸ’³','ðŸ§¾','âœ‰ï¸','ðŸ“§','ðŸ“¨','ðŸ“©','ðŸ“¤','ðŸ“¥','ðŸ“¦','ðŸ“«','ðŸ“ª','ðŸ“¬','ðŸ“­','ðŸ“®','ðŸ—³ï¸','âœï¸','âœ’ï¸','ðŸ–‹ï¸','ðŸ–Šï¸','ðŸ–Œï¸','ðŸ–ï¸','ðŸ“','ðŸ’¼','ðŸ“','ðŸ“‚','ðŸ—‚ï¸','ðŸ“…','ðŸ“†','ðŸ—’ï¸','ðŸ—“ï¸','ðŸ“‡','ðŸ“ˆ','ðŸ“‰','ðŸ“Š','ðŸ“‹','ðŸ“Œ','ðŸ“','ðŸ“Ž','ðŸ–‡ï¸','ðŸ“','ðŸ“','âœ‚ï¸','ðŸ—ƒï¸','ðŸ—„ï¸','ðŸ—‘ï¸','ðŸ”’','ðŸ”“','ðŸ”','ðŸ”','ðŸ”‘','ðŸ—ï¸','ðŸ”¨','ðŸª“','â›ï¸','âš’ï¸','ðŸ› ï¸','ðŸ—¡ï¸','âš”ï¸','ðŸ”«','ðŸªƒ','ðŸ¹','ðŸ›¡ï¸','ðŸªš','ðŸ”§','ðŸª›','ðŸ”©','âš™ï¸','ðŸ—œï¸','âš–ï¸','ðŸ¦¯','ðŸ”—','â›“ï¸','ðŸª','ðŸ§°','ðŸ§²','ðŸªœ','âš—ï¸','ðŸ§ª','ðŸ§«','ðŸ§¬','ðŸ”¬','ðŸ”­','ðŸ“¡','ðŸ’‰','ðŸ©¸','ðŸ’Š','ðŸ©¹','ðŸ©º','ðŸ©»','ðŸšª','ðŸ›—','ðŸªž','ðŸªŸ','ðŸ›ï¸','ðŸ›‹ï¸','ðŸª‘','ðŸš½','ðŸª ','ðŸš¿','ðŸ›','ðŸª¤','ðŸª’','ðŸ§´','ðŸ§·','ðŸ§¹','ðŸ§º','ðŸ§»','ðŸª£','ðŸ§¼','ðŸ«§','ðŸª¥','ðŸ§½','ðŸ§¯','ðŸ›’','ðŸš¬','âš°ï¸','ðŸª¦','âš±ï¸','ðŸ—¿','ðŸª§','ðŸªª',
            // SYMBOLS
            'ðŸ§','ðŸš®','ðŸš°','â™¿','ðŸš¹','ðŸšº','ðŸš»','ðŸš¼','ðŸš¾','ðŸ›‚','ðŸ›ƒ','ðŸ›„','ðŸ›…','âš ï¸','ðŸš¸','â›”','ðŸš«','ðŸš³','ðŸš­','ðŸš¯','ðŸš±','ðŸš·','ðŸ“µ','ðŸ”ž','â˜¢ï¸','â˜£ï¸','â¬†ï¸','â†—ï¸','âž¡ï¸','â†˜ï¸','â¬‡ï¸','â†™ï¸','â¬…ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†©ï¸','â†ªï¸','â¤´ï¸','â¤µï¸','ðŸ”ƒ','ðŸ”„','ðŸ”™','ðŸ”š','ðŸ”›','ðŸ”œ','ðŸ”','ðŸ›','âš›ï¸','ðŸ•‰ï¸','âœ¡ï¸','â˜¸ï¸','â˜¯ï¸','âœï¸','â˜¦ï¸','â˜ªï¸','â˜®ï¸','ðŸ•Ž','ðŸ”¯','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™Ž','â™','â™','â™‘','â™’','â™“','â›Ž','ðŸ”€','ðŸ”','ðŸ”‚','â–¶ï¸','â©','â­ï¸','â¯ï¸','â—€ï¸','âª','â®ï¸','ðŸ”¼','â«','ðŸ”½','â¬','â¸ï¸','â¹ï¸','âºï¸','âï¸','ðŸŽ¦','ðŸ”…','ðŸ”†','ðŸ“¶','ðŸ“³','ðŸ“´','â™€ï¸','â™‚ï¸','âš§ï¸','âœ–ï¸','âž•','âž–','âž—','â™¾ï¸','â€¼ï¸','â‰ï¸','â“','â”','â•','â—','ã€°ï¸','ðŸ’±','ðŸ’²','âš•ï¸','â™»ï¸','âšœï¸','ðŸ”±','ðŸ“›','ðŸ”°','â­•','âœ…','â˜‘ï¸','âœ”ï¸','âŒ','âŽ','âž°','âž¿','ã€½ï¸','âœ³ï¸','âœ´ï¸','â‡ï¸','Â©ï¸','Â®ï¸','â„¢ï¸','#ï¸âƒ£','*ï¸âƒ£','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ðŸ”Ÿ','ðŸ” ','ðŸ”¡','ðŸ”¢','ðŸ”£','ðŸ”¤','ðŸ…°ï¸','ðŸ†Ž','ðŸ…±ï¸','ðŸ†‘','ðŸ†’','ðŸ†“','â„¹ï¸','ðŸ†”','â“‚ï¸','ðŸ†•','ðŸ†–','ðŸ…¾ï¸','ðŸ†—','ðŸ…¿ï¸','ðŸ†˜','ðŸ†™','ðŸ†š','ðŸˆ','ðŸˆ‚ï¸','ðŸˆ·ï¸','ðŸˆ¶','ðŸˆ¯','ðŸ‰','ðŸˆ¹','ðŸˆš','ðŸˆ²','ðŸ‰‘','ðŸˆ¸','ðŸˆ´','ðŸˆ³','ãŠ—ï¸','ãŠ™ï¸','ðŸˆº','ðŸˆµ','ðŸ”´','ðŸŸ ','ðŸŸ¡','ðŸŸ¢','ðŸ”µ','ðŸŸ£','ðŸŸ¤','âš«','âšª','ðŸŸ¥','ðŸŸ§','ðŸŸ¨','ðŸŸ©','ðŸŸ¦','ðŸŸª','ðŸŸ«','â¬›','â¬œ','â—¼ï¸','â—»ï¸','â—¾','â—½','â–ªï¸','â–«ï¸','ðŸ”¶','ðŸ”·','ðŸ”¸','ðŸ”¹','ðŸ”º','ðŸ”»','ðŸ’ ','ðŸ”˜','ðŸ”³','ðŸ”²',
            // FLAGS
            'ðŸ','ðŸš©','ðŸŽŒ','ðŸ´','ðŸ³ï¸','ðŸ³ï¸â€ðŸŒˆ','ðŸ³ï¸â€âš§ï¸','ðŸ´â€â˜ ï¸',
            'ðŸ‡¦ðŸ‡¨','ðŸ‡¦ðŸ‡©','ðŸ‡¦ðŸ‡ª','ðŸ‡¦ðŸ‡«','ðŸ‡¦ðŸ‡¬','ðŸ‡¦ðŸ‡®','ðŸ‡¦ðŸ‡±','ðŸ‡¦ðŸ‡²','ðŸ‡¦ðŸ‡´','ðŸ‡¦ðŸ‡¶','ðŸ‡¦ðŸ‡·','ðŸ‡¦ðŸ‡¹','ðŸ‡¦ðŸ‡º','ðŸ‡¦ðŸ‡¼','ðŸ‡¦ðŸ‡½','ðŸ‡¦ðŸ‡¿','ðŸ‡§ðŸ‡¦','ðŸ‡§ðŸ‡§','ðŸ‡§ðŸ‡©','ðŸ‡§ðŸ‡ª','ðŸ‡§ðŸ‡«','ðŸ‡§ðŸ‡¬','ðŸ‡§ðŸ‡­','ðŸ‡§ðŸ‡®','ðŸ‡§ðŸ‡¯','ðŸ‡§ðŸ‡±','ðŸ‡§ðŸ‡²','ðŸ‡§ðŸ‡³','ðŸ‡§ðŸ‡´','ðŸ‡§ðŸ‡¶','ðŸ‡§ðŸ‡·','ðŸ‡§ðŸ‡¸','ðŸ‡§ðŸ‡¹','ðŸ‡§ðŸ‡»','ðŸ‡§ðŸ‡¼','ðŸ‡§ðŸ‡¾','ðŸ‡§ðŸ‡¿','ðŸ‡¨ðŸ‡¦','ðŸ‡¨ðŸ‡¨','ðŸ‡¨ðŸ‡©','ðŸ‡¨ðŸ‡«','ðŸ‡¨ðŸ‡¬','ðŸ‡¨ðŸ‡­','ðŸ‡¨ðŸ‡®','ðŸ‡¨ðŸ‡°','ðŸ‡¨ðŸ‡±','ðŸ‡¨ðŸ‡²','ðŸ‡¨ðŸ‡³','ðŸ‡¨ðŸ‡´','ðŸ‡¨ðŸ‡µ','ðŸ‡¨ðŸ‡·','ðŸ‡¨ðŸ‡º','ðŸ‡¨ðŸ‡»','ðŸ‡¨ðŸ‡¼','ðŸ‡¨ðŸ‡½','ðŸ‡¨ðŸ‡¾','ðŸ‡¨ðŸ‡¿','ðŸ‡©ðŸ‡ª','ðŸ‡©ðŸ‡¬','ðŸ‡©ðŸ‡¯','ðŸ‡©ðŸ‡°','ðŸ‡©ðŸ‡²','ðŸ‡©ðŸ‡´','ðŸ‡©ðŸ‡¿','ðŸ‡ªðŸ‡¦','ðŸ‡ªðŸ‡¨','ðŸ‡ªðŸ‡ª','ðŸ‡ªðŸ‡¬','ðŸ‡ªðŸ‡­','ðŸ‡ªðŸ‡·','ðŸ‡ªðŸ‡¸','ðŸ‡ªðŸ‡¹','ðŸ‡ªðŸ‡º','ðŸ‡«ðŸ‡®','ðŸ‡«ðŸ‡¯','ðŸ‡«ðŸ‡°','ðŸ‡«ðŸ‡²','ðŸ‡«ðŸ‡´','ðŸ‡«ðŸ‡·','ðŸ‡¬ðŸ‡¦','ðŸ‡¬ðŸ‡§','ðŸ‡¬ðŸ‡©','ðŸ‡¬ðŸ‡ª','ðŸ‡¬ðŸ‡«','ðŸ‡¬ðŸ‡¬','ðŸ‡¬ðŸ‡­','ðŸ‡¬ðŸ‡®','ðŸ‡¬ðŸ‡±','ðŸ‡¬ðŸ‡²','ðŸ‡¬ðŸ‡³','ðŸ‡¬ðŸ‡µ','ðŸ‡¬ðŸ‡¶','ðŸ‡¬ðŸ‡·','ðŸ‡¬ðŸ‡¸','ðŸ‡¬ðŸ‡¹','ðŸ‡¬ðŸ‡º','ðŸ‡¬ðŸ‡¼','ðŸ‡¬ðŸ‡¾','ðŸ‡­ðŸ‡°','ðŸ‡­ðŸ‡²','ðŸ‡­ðŸ‡³','ðŸ‡­ðŸ‡·','ðŸ‡­ðŸ‡¹','ðŸ‡­ðŸ‡º','ðŸ‡®ðŸ‡¨','ðŸ‡®ðŸ‡©','ðŸ‡®ðŸ‡ª','ðŸ‡®ðŸ‡±','ðŸ‡®ðŸ‡²','ðŸ‡®ðŸ‡³','ðŸ‡®ðŸ‡´','ðŸ‡®ðŸ‡¶','ðŸ‡®ðŸ‡·','ðŸ‡®ðŸ‡¸','ðŸ‡®ðŸ‡¹','ðŸ‡¯ðŸ‡ª','ðŸ‡¯ðŸ‡²','ðŸ‡¯ðŸ‡´','ðŸ‡¯ðŸ‡µ','ðŸ‡°ðŸ‡ª','ðŸ‡°ðŸ‡¬','ðŸ‡°ðŸ‡­','ðŸ‡°ðŸ‡®','ðŸ‡°ðŸ‡²','ðŸ‡°ðŸ‡³','ðŸ‡°ðŸ‡µ','ðŸ‡°ðŸ‡·','ðŸ‡°ðŸ‡¼','ðŸ‡°ðŸ‡¾','ðŸ‡°ðŸ‡¿','ðŸ‡±ðŸ‡¦','ðŸ‡±ðŸ‡§','ðŸ‡±ðŸ‡¨','ðŸ‡±ðŸ‡®','ðŸ‡±ðŸ‡°','ðŸ‡±ðŸ‡·','ðŸ‡±ðŸ‡¸','ðŸ‡±ðŸ‡¹','ðŸ‡±ðŸ‡º','ðŸ‡±ðŸ‡»','ðŸ‡±ðŸ‡¾','ðŸ‡²ðŸ‡¦','ðŸ‡²ðŸ‡¨','ðŸ‡²ðŸ‡©','ðŸ‡²ðŸ‡ª','ðŸ‡²ðŸ‡«','ðŸ‡²ðŸ‡¬','ðŸ‡²ðŸ‡­','ðŸ‡²ðŸ‡°','ðŸ‡²ðŸ‡±','ðŸ‡²ðŸ‡²','ðŸ‡²ðŸ‡³','ðŸ‡²ðŸ‡´','ðŸ‡²ðŸ‡µ','ðŸ‡²ðŸ‡¶','ðŸ‡²ðŸ‡·','ðŸ‡²ðŸ‡¸','ðŸ‡²ðŸ‡¹','ðŸ‡²ðŸ‡º','ðŸ‡²ðŸ‡»','ðŸ‡²ðŸ‡¼','ðŸ‡²ðŸ‡½','ðŸ‡²ðŸ‡¾','ðŸ‡²ðŸ‡¿','ðŸ‡³ðŸ‡¦','ðŸ‡³ðŸ‡¨','ðŸ‡³ðŸ‡ª','ðŸ‡³ðŸ‡«','ðŸ‡³ðŸ‡¬','ðŸ‡³ðŸ‡®','ðŸ‡³ðŸ‡±','ðŸ‡³ðŸ‡´','ðŸ‡³ðŸ‡µ','ðŸ‡³ðŸ‡·','ðŸ‡³ðŸ‡º','ðŸ‡³ðŸ‡¿','ðŸ‡´ðŸ‡²','ðŸ‡µðŸ‡¦','ðŸ‡µðŸ‡ª','ðŸ‡µðŸ‡«','ðŸ‡µðŸ‡¬','ðŸ‡µðŸ‡­','ðŸ‡µðŸ‡°','ðŸ‡µðŸ‡±','ðŸ‡µðŸ‡²','ðŸ‡µðŸ‡³','ðŸ‡µðŸ‡·','ðŸ‡µðŸ‡¸','ðŸ‡µðŸ‡¹','ðŸ‡µðŸ‡¼','ðŸ‡µðŸ‡¾','ðŸ‡¶ðŸ‡¦','ðŸ‡·ðŸ‡ª','ðŸ‡·ðŸ‡´','ðŸ‡·ðŸ‡¸','ðŸ‡·ðŸ‡º','ðŸ‡·ðŸ‡¼','ðŸ‡¸ðŸ‡¦','ðŸ‡¸ðŸ‡§','ðŸ‡¸ðŸ‡¨','ðŸ‡¸ðŸ‡©','ðŸ‡¸ðŸ‡ª','ðŸ‡¸ðŸ‡¬','ðŸ‡¸ðŸ‡­','ðŸ‡¸ðŸ‡®','ðŸ‡¸ðŸ‡¯','ðŸ‡¸ðŸ‡°','ðŸ‡¸ðŸ‡±','ðŸ‡¸ðŸ‡²','ðŸ‡¸ðŸ‡³','ðŸ‡¸ðŸ‡´','ðŸ‡¸ðŸ‡·','ðŸ‡¸ðŸ‡¸','ðŸ‡¸ðŸ‡¹','ðŸ‡¸ðŸ‡»','ðŸ‡¸ðŸ‡½','ðŸ‡¸ðŸ‡¾','ðŸ‡¸ðŸ‡¿','ðŸ‡¹ðŸ‡¦','ðŸ‡¹ðŸ‡¨','ðŸ‡¹ðŸ‡©','ðŸ‡¹ðŸ‡«','ðŸ‡¹ðŸ‡¬','ðŸ‡¹ðŸ‡­','ðŸ‡¹ðŸ‡¯','ðŸ‡¹ðŸ‡°','ðŸ‡¹ðŸ‡±','ðŸ‡¹ðŸ‡²','ðŸ‡¹ðŸ‡³','ðŸ‡¹ðŸ‡´','ðŸ‡¹ðŸ‡·','ðŸ‡¹ðŸ‡¹','ðŸ‡¹ðŸ‡»','ðŸ‡¹ðŸ‡¼','ðŸ‡¹ðŸ‡¿','ðŸ‡ºðŸ‡¦','ðŸ‡ºðŸ‡¬','ðŸ‡ºðŸ‡²','ðŸ‡ºðŸ‡³','ðŸ‡ºðŸ‡¸','ðŸ‡ºðŸ‡¾','ðŸ‡ºðŸ‡¿','ðŸ‡»ðŸ‡¦','ðŸ‡»ðŸ‡¨','ðŸ‡»ðŸ‡ª','ðŸ‡»ðŸ‡¬','ðŸ‡»ðŸ‡®','ðŸ‡»ðŸ‡³','ðŸ‡»ðŸ‡º','ðŸ‡¼ðŸ‡«','ðŸ‡¼ðŸ‡¸','ðŸ‡½ðŸ‡°','ðŸ‡¾ðŸ‡ª','ðŸ‡¾ðŸ‡¹','ðŸ‡¿ðŸ‡¦','ðŸ‡¿ðŸ‡²','ðŸ‡¿ðŸ‡¼','ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿','ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿','ðŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿'
        ];

        // Fitzpatrick Modifiers
        const SKIN_TONES = ['ðŸ»', 'ðŸ¼', 'ðŸ½', 'ðŸ¾', 'ðŸ¿'];
        
        // Massive list of ALL emojis that support skin tones (People, Body Parts, Gestures)
        // This ensures the mosaic engine has thousands of shades to pick from.
        const SKINNABLE_BASES = [
            // HANDS
            'ðŸ‘‹','ðŸ¤š','âœ‹','ðŸ––','ðŸ‘Œ','ðŸ¤Œ','ðŸ¤','âœŒï¸','ðŸ¤ž','ðŸ¤Ÿ','ðŸ¤˜','ðŸ¤™','ðŸ‘ˆ','ðŸ‘‰','ðŸ‘†','ðŸ‘‡','â˜ï¸','ðŸ‘','ðŸ‘Ž','âœŠ','ðŸ‘Š','ðŸ¤›','ðŸ¤œ','ðŸ‘','ðŸ™Œ','ðŸ‘','ðŸ¤²','ðŸ¤','ðŸ™','âœï¸','ðŸ’…','ðŸ¤³','ðŸ’ª','ðŸ¦µ','ðŸ¦¶','ðŸ‘‚','ðŸ¦»','ðŸ‘ƒ',
            // PEOPLE
            'ðŸ‘¶','ðŸ‘§','ðŸ§’','ðŸ‘¦','ðŸ‘©','ðŸ§‘','ðŸ‘¨','ðŸ‘©â€ðŸ¦±','ðŸ§‘â€ðŸ¦±','ðŸ‘¨â€ðŸ¦±','ðŸ‘©â€ðŸ¦°','ðŸ§‘â€ðŸ¦°','ðŸ‘¨â€ðŸ¦°','ðŸ‘©â€ðŸ¦³','ðŸ§‘â€ðŸ¦³','ðŸ‘¨â€ðŸ¦³','ðŸ‘©â€ðŸ¦²','ðŸ§‘â€ðŸ¦²','ðŸ‘¨â€ðŸ¦²','ðŸ‘±â€â™€ï¸','ðŸ‘±','ðŸ‘±â€â™‚ï¸','ðŸ‘µ','ðŸ§“','ðŸ‘´','ðŸ‘²','ðŸ‘³â€â™€ï¸','ðŸ‘³','ðŸ‘³â€â™‚ï¸','ðŸ§•','ðŸ‘®â€â™€ï¸','ðŸ‘®','ðŸ‘®â€â™‚ï¸','ðŸ‘·â€â™€ï¸','ðŸ‘·','ðŸ‘·â€â™‚ï¸','ðŸ’‚â€â™€ï¸','ðŸ’‚','ðŸ’‚â€â™‚ï¸','ðŸ•µï¸â€â™€ï¸','ðŸ•µï¸','ðŸ•µï¸â€â™‚ï¸','ðŸ‘©â€âš•ï¸','ðŸ§‘â€âš•ï¸','ðŸ‘¨â€âš•ï¸','ðŸ‘©â€ðŸŒ¾','ðŸ§‘â€ðŸŒ¾','ðŸ‘¨â€ðŸŒ¾','ðŸ‘©â€ðŸ³','ðŸ§‘â€ðŸ³','ðŸ‘¨â€ðŸ³','ðŸ‘©â€ðŸŽ“','ðŸ§‘â€ðŸŽ“','ðŸ‘¨â€ðŸŽ“','ðŸ‘©â€ðŸŽ¤','ðŸ§‘â€ðŸŽ¤','ðŸ‘¨â€ðŸŽ¤','ðŸ‘©â€ðŸ«','ðŸ§‘â€ðŸ«','ðŸ‘¨â€ðŸ«','ðŸ‘©â€ðŸ­','ðŸ§‘â€ðŸ­','ðŸ‘¨â€ðŸ­','ðŸ‘©â€ðŸ’»','ðŸ§‘â€ðŸ’»','ðŸ‘¨â€ðŸ’»','ðŸ‘©â€ðŸ’¼','ðŸ§‘â€ðŸ’¼','ðŸ‘¨â€ðŸ’¼','ðŸ‘©â€ðŸ”§','ðŸ§‘â€ðŸ”§','ðŸ‘¨â€ðŸ”§','ðŸ‘©â€ðŸ”¬','ðŸ§‘â€ðŸ”¬','ðŸ‘¨â€ðŸ”¬','ðŸ‘©â€ðŸŽ¨','ðŸ§‘â€ðŸŽ¨','ðŸ‘¨â€ðŸŽ¨','ðŸ‘©â€ðŸš’','ðŸ§‘â€ðŸš’','ðŸ‘¨â€ðŸš’','ðŸ‘©â€âœˆï¸','ðŸ§‘â€âœˆï¸','ðŸ‘¨â€âœˆï¸','ðŸ‘©â€ðŸš€','ðŸ§‘â€ðŸš€','ðŸ‘¨â€ðŸš€','ðŸ‘©â€âš–ï¸','ðŸ§‘â€âš–ï¸','ðŸ‘¨â€âš–ï¸','ðŸ‘°â€â™€ï¸','ðŸ‘°','ðŸ‘°â€â™‚ï¸','ðŸ¤µâ€â™€ï¸','ðŸ¤µ','ðŸ¤µâ€â™‚ï¸','ðŸ‘¸','ðŸ¤´','ðŸ¥·','ðŸ¦¸â€â™€ï¸','ðŸ¦¸','ðŸ¦¸â€â™‚ï¸','ðŸ¦¹â€â™€ï¸','ðŸ¦¹','ðŸ¦¹â€â™‚ï¸','ðŸ¤¶','ðŸŽ…','ðŸ§™â€â™€ï¸','ðŸ§™','ðŸ§™â€â™‚ï¸','ðŸ§â€â™€ï¸','ðŸ§','ðŸ§â€â™‚ï¸','ðŸ§›â€â™€ï¸','ðŸ§›','ðŸ§›â€â™‚ï¸','ðŸ§œâ€â™€ï¸','ðŸ§œ','ðŸ§œâ€â™‚ï¸','ðŸ§šâ€â™€ï¸','ðŸ§š','ðŸ§šâ€â™‚ï¸','ðŸ‘¼','ðŸ¤°','ðŸ¤±','ðŸ‘©â€ðŸ¼','ðŸ§‘â€ðŸ¼','ðŸ‘¨â€ðŸ¼','ðŸ™‡â€â™€ï¸','ðŸ™‡','ðŸ™‡â€â™‚ï¸','ðŸ’â€â™€ï¸','ðŸ’','ðŸ’â€â™‚ï¸','ðŸ™…â€â™€ï¸','ðŸ™…','ðŸ™…â€â™‚ï¸','ðŸ™†â€â™€ï¸','ðŸ™†','ðŸ™†â€â™‚ï¸','ðŸ™‹â€â™€ï¸','ðŸ™‹','ðŸ™‹â€â™‚ï¸','ðŸ§â€â™€ï¸','ðŸ§','ðŸ§â€â™‚ï¸','ðŸ¤¦â€â™€ï¸','ðŸ¤¦','ðŸ¤¦â€â™‚ï¸','ðŸ¤·â€â™€ï¸','ðŸ¤·','ðŸ¤·â€â™‚ï¸','ðŸ™Žâ€â™€ï¸','ðŸ™Ž','ðŸ™Žâ€â™‚ï¸','ðŸ™â€â™€ï¸','ðŸ™','ðŸ™â€â™‚ï¸','ðŸ’‡â€â™€ï¸','ðŸ’‡','ðŸ’‡â€â™‚ï¸','ðŸ’†â€â™€ï¸','ðŸ’†','ðŸ’†â€â™‚ï¸','ðŸ§–â€â™€ï¸','ðŸ§–','ðŸ§–â€â™‚ï¸','ðŸ’ƒ','ðŸ•º','ðŸ•´ï¸','ðŸ§—â€â™€ï¸','ðŸ§—','ðŸ§—â€â™‚ï¸','ðŸ¤º','ðŸ‡','â›·ï¸','ðŸ‚','ðŸŒï¸â€â™€ï¸','ðŸŒï¸','ðŸŒï¸â€â™‚ï¸','ðŸ„â€â™€ï¸','ðŸ„','ðŸ„â€â™‚ï¸','ðŸš£â€â™€ï¸','ðŸš£','ðŸš£â€â™‚ï¸','ðŸŠâ€â™€ï¸','ðŸŠ','ðŸŠâ€â™‚ï¸','â›¹ï¸â€â™€ï¸','â›¹ï¸','â›¹ï¸â€â™‚ï¸','ðŸ‹ï¸â€â™€ï¸','ðŸ‹ï¸','ðŸ‹ï¸â€â™‚ï¸','ðŸš´â€â™€ï¸','ðŸš´','ðŸš´â€â™‚ï¸','ðŸšµâ€â™€ï¸','ðŸšµ','ðŸšµâ€â™‚ï¸','ðŸ¤¸â€â™€ï¸','ðŸ¤¸','ðŸ¤¸â€â™‚ï¸','ðŸ¤¼â€â™€ï¸','ðŸ¤¼','ðŸ¤¼â€â™‚ï¸','ðŸ¤½â€â™€ï¸','ðŸ¤½','ðŸ¤½â€â™‚ï¸','ðŸ¤¾â€â™€ï¸','ðŸ¤¾','ðŸ¤¾â€â™‚ï¸','ðŸ¤¹â€â™€ï¸','ðŸ¤¹','ðŸ¤¹â€â™‚ï¸','ðŸ§˜â€â™€ï¸','ðŸ§˜','ðŸ§˜â€â™‚ï¸','ðŸ›€','ðŸ›Œ'
        ];

        // --- 2. State Management ---
        const state = {
            image: null,
            emojiDB: [],
            currentJobId: 0,
            
            // Spatial State
            wsPan: { x: 0, y: 0 },
            wsZoom: 0.85,
            
            // Image Content State
            imgPan: { x: 50, y: 50 }, // Center %
            imgZoom: 1.0,
            
            // Mouse Interaction State
            isDragging: false,
            lastMouse: { x: 0, y: 0 },
            isWsPanning: false,

            settings: {
                aspectRatio: 0,
                filter: 'none',
                contrast: 100,
                brightness: 100,
                saturation: 100,
                resolution: 1920,
                cellSize: 12,
                spacing: 0,
                chaos: 0,
                onionSkin: false,
                bgColor: '#000000',
                isTransparent: false
            },
            worker: null
        };

        // --- 3. DOM Elements ---
        const els = {
            stage: document.getElementById('stage'),
            canvasWrapper: document.getElementById('canvasWrapper'),
            emojiCanvas: document.getElementById('emojiCanvas'),
            bgCanvas: document.getElementById('bgCanvas'),
            scanline: document.getElementById('scanline'),
            emptyState: document.getElementById('emptyState'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            downloadBtn: document.getElementById('downloadBtn'),
            fileInput: document.getElementById('fileInput'),
            
            // HUD
            statusDot: document.getElementById('statusDot'),
            statusText: document.getElementById('statusText'),
            statusCapsule: document.getElementById('statusCapsule'),
            helpTrigger: document.getElementById('helpTrigger'),
            helpModal: document.getElementById('helpModal'),
            mobileSettingsToggle: document.getElementById('mobileSettingsToggle'),
            sidebar: document.getElementById('sidebar'),

            // Controls
            resetStyleBtn: document.getElementById('resetStyleBtn'),
            aspectRatio: document.getElementById('aspectRatio'),
            zoomSlider: document.getElementById('zoomSlider'),
            zoomDisplay: document.getElementById('zoomDisplay'),
            filterPreset: document.getElementById('filterPreset'),
            contrast: document.getElementById('contrast'),
            brightness: document.getElementById('brightness'),
            saturation: document.getElementById('saturation'),
            cellSize: document.getElementById('cellSize'),
            spacing: document.getElementById('spacing'),
            chaos: document.getElementById('chaos'),
            resolution: document.getElementById('resolution'),
            onionToggle: document.getElementById('onionToggle'),
            onionKnob: document.getElementById('onionKnob'),
            bgColorPicker: document.getElementById('bgColorPicker'),
            transparentToggle: document.getElementById('transparentToggle'),
            
            // Values
            contrastVal: document.getElementById('contrastVal'),
            brightnessVal: document.getElementById('brightnessVal'),
            saturationVal: document.getElementById('saturationVal'),
            cellSizeVal: document.getElementById('cellSizeVal'),
            spacingVal: document.getElementById('spacingVal'),
            chaosVal: document.getElementById('chaosVal'),
            resolutionVal: document.getElementById('resolutionVal'),
        };

        // --- 4. Web Worker ---
        const workerScript = `
            self.onmessage = function(e) {
                const { jobId, imageData, emojiDB, cellSize, spacing, chaos, width, height } = e.data;
                const data = new Uint8ClampedArray(imageData); 
                
                const step = Math.max(1, cellSize + spacing);
                const cols = Math.ceil(width / step);
                const rows = Math.ceil(height / step);
                const results = [];

                function colorDistance(r1, g1, b1, r2, g2, b2) {
                    const rmean = (r1 + r2) / 2;
                    const r = r1 - r2;
                    const g = g1 - g2;
                    const b = b1 - b2;
                    return Math.sqrt((((512 + rmean) * r * r) >> 8) + 4 * g * g + (((767 - rmean) * b * b) >> 8));
                }

                const totalCells = rows * cols;

                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        const pixelX = Math.floor(x * step);
                        const pixelY = Math.floor(y * step);
                        
                        let r = 0, g = 0, b = 0, count = 0;
                        const stride = Math.max(1, Math.floor(cellSize / 4));

                        for (let py = 0; py < cellSize; py += stride) {
                            for (let px = 0; px < cellSize; px += stride) {
                                const sx = pixelX + px;
                                const sy = pixelY + py;
                                if (sx < width && sy < height) {
                                    const index = (sy * width + sx) * 4;
                                    if (data[index + 3] > 20) {
                                        r += data[index];
                                        g += data[index + 1];
                                        b += data[index + 2];
                                        count++;
                                    }
                                }
                            }
                        }

                        if (count > 0) {
                            r = Math.floor(r / count);
                            g = Math.floor(g / count);
                            b = Math.floor(b / count);

                            let bestEmoji = null;
                            if (chaos === 0) {
                                let bestDist = Infinity;
                                for (let i = 0; i < emojiDB.length; i++) {
                                    const em = emojiDB[i];
                                    const d = colorDistance(r, g, b, em.r, em.g, em.b);
                                    if (d < bestDist) {
                                        bestDist = d;
                                        bestEmoji = em.char;
                                    }
                                }
                                results.push({ x: pixelX, y: pixelY, char: bestEmoji });
                            } else {
                                const range = Math.max(1, Math.ceil((chaos / 100) * 15));
                                const dists = emojiDB.map(em => ({ ch: em.char, d: colorDistance(r,g,b,em.r,em.g,em.b) }));
                                dists.sort((a,b) => a.d - b.d);
                                const pick = dists[Math.floor(Math.random() * range)];
                                results.push({ x: pixelX, y: pixelY, char: pick.ch });
                            }
                        }
                    }
                    if (y % 15 === 0) {
                         self.postMessage({ type: 'progress', jobId, percent: Math.round((y/rows)*100) });
                    }
                }
                self.postMessage({ type: 'complete', jobId, results, meta: { width, height, cellSize } });
            };
        `;

        // --- 5. Initialization ---
        async function init() {
            const blob = new Blob([workerScript], { type: 'application/javascript' });
            state.worker = new Worker(URL.createObjectURL(blob));
            state.worker.onmessage = handleWorkerMessage;
            
            // Fix: Add error handler for worker to prevent stuck states on crash
            state.worker.onerror = function(e) {
                console.error('Worker Error:', e);
                setStatus('Error', false);
            };

            await buildEmojiDB();
            setupListeners();
            setupSpatialControls();
            els.loadingOverlay.style.display = 'none';
        }

        async function buildEmojiDB() {
            return new Promise((resolve) => {
                const size = 32;
                const canvas = document.createElement('canvas');
                canvas.width = size; canvas.height = size;
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                ctx.font = `${size * 0.8}px sans-serif`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

                // 1. Start with filtered base list
                let fullPalette = [...RAW_EMOJI_BASE];

                // 2. Add ALL skin tone variants for ALL skinnable bases
                SKINNABLE_BASES.forEach(base => {
                    // Ensure base is in palette (if not already)
                    if (!fullPalette.includes(base)) {
                        fullPalette.push(base);
                    }
                    // Add all 5 tones
                    SKIN_TONES.forEach(tone => {
                        fullPalette.push(base + tone);
                    });
                });
                
                // Remove duplicates just in case
                fullPalette = [...new Set(fullPalette)];

                state.emojiDB = fullPalette.map(char => {
                    ctx.clearRect(0, 0, size, size);
                    ctx.fillText(char, size/2, size/2 + 2);
                    const data = ctx.getImageData(0, 0, size, size).data;
                    let r=0, g=0, b=0, count=0;
                    for (let i=0; i<data.length; i+=4) {
                        if (data[i+3] > 50) { r += data[i]; g += data[i+1]; b += data[i+2]; count++; }
                    }
                    if (count === 0) return { char, r:0, g:0, b:0 };
                    return { char, r: Math.round(r/count), g: Math.round(g/count), b: Math.round(b/count) };
                });
                resolve();
            });
        }

        // --- 6. Event Listeners ---
        function setupListeners() {
            window.addEventListener('dragover', (e) => e.preventDefault());
            window.addEventListener('drop', handleDrop);

            // Native Upload Handlers
            els.emptyState.addEventListener('click', () => els.fileInput.click());
            els.fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) loadFile(e.target.files[0]);
            });
            
            // Mobile Settings Toggle
            els.mobileSettingsToggle.addEventListener('click', () => {
                // We use translate-y-0 to bring it into view because default is -translate-y-[150%]
                els.sidebar.classList.toggle('translate-y-0');
            });

            // Resizing window handler
            window.addEventListener('resize', debounce(() => {
                if(state.image) fitWorkspace();
            }, 100));

            const triggerWorker = debounce(() => processImage(), 150);

            // Controls
            ['filterPreset', 'contrast', 'brightness', 'saturation', 'zoomSlider'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', (e) => {
                    if(id === 'zoomSlider') state.imgZoom = parseFloat(e.target.value);
                    updateSettings();
                    updateUIValues();
                    updatePreviewLayer(); 
                    if (!state.isDragging) triggerWorker();
                });
            });

            ['aspectRatio', 'cellSize', 'spacing', 'chaos', 'resolution'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    updateSettings();
                    updateUIValues();
                    setStatus(`Queued...`, true);
                    triggerWorker();
                });
            });

            els.resetStyleBtn.addEventListener('click', () => {
                els.contrast.value = 100; els.brightness.value = 100; els.saturation.value = 100; els.filterPreset.value = 'none';
                updateSettings(); updateUIValues(); updatePreviewLayer(); triggerWorker();
            });

            els.onionToggle.addEventListener('click', () => {
                state.settings.onionSkin = !state.settings.onionSkin;
                updateSettings(); updateToggles(); updatePreviewLayer();
            });
            els.bgColorPicker.addEventListener('input', (e) => {
                state.settings.bgColor = e.target.value;
                updateSettings(); updatePreviewLayer();
            });
            els.transparentToggle.addEventListener('change', (e) => {
                state.settings.isTransparent = e.target.checked;
                updateSettings();
                els.canvasWrapper.classList.toggle('transparent-bg', state.settings.isTransparent);
                updatePreviewLayer();
            });
            els.downloadBtn.addEventListener('click', exportImage);
            
            // Help Modal Interaction
            els.helpTrigger.addEventListener('mouseenter', () => els.helpModal.classList.add('hover-active'));
            els.helpTrigger.addEventListener('mouseleave', () => els.helpModal.classList.remove('hover-active'));
            els.helpTrigger.addEventListener('click', () => els.helpModal.classList.toggle('active'));
            window.addEventListener('click', (e) => {
                if(!els.helpModal.contains(e.target) && !els.helpTrigger.contains(e.target)) {
                    els.helpModal.classList.remove('active');
                }
            });
            window.addEventListener('keydown', (e) => {
                if(e.key === 'Escape') els.helpModal.classList.remove('active');
            });
        }

        // --- 7. Status & Updates ---
        function setStatus(msg, isBusy = true) {
            els.statusText.innerText = msg;
            els.statusDot.classList.toggle('busy', isBusy);
            els.statusCapsule.style.transform = isBusy ? 'scale(1.05)' : 'scale(1)';
        }

        function fitWorkspace() {
            if (!state.image) return;
            // Calculate scale to fit image in current window with padding
            const pad = 120; 
            const sidebarWidth = window.innerWidth < 768 ? 0 : 320; // Zero width sidebar calc on mobile
            const availableW = window.innerWidth - sidebarWidth - pad;
            const availableH = window.innerHeight - pad;
            
            let targetW = state.settings.resolution;
            let targetH = state.settings.aspectRatio !== 0 
                ? targetW / state.settings.aspectRatio 
                : targetW * (state.image.height / state.image.width);

            const scaleW = availableW / targetW;
            const scaleH = availableH / targetH;
            
            state.wsZoom = Math.min(1, Math.min(scaleW, scaleH));
            
            // Re-center. Since we are now absolute 50/50, (0,0) is the center of screen.
            // We want to center it in the "visual" area left of sidebar.
            // Visual Center X = (WindowWidth - Sidebar) / 2
            // Absolute Center X = WindowWidth / 2
            // Offset = Visual Center - Absolute Center = -Sidebar / 2
            state.wsPan = { x: -sidebarWidth/2, y: 0 };
            updateWorkspaceTransform();
        }

        function setupSpatialControls() {
            const keys = { Space: false };
            window.addEventListener('keydown', e => { if(e.code === 'Space') { keys.Space = true; document.body.classList.add('space-held'); }});
            window.addEventListener('keyup', e => { if(e.code === 'Space') { keys.Space = false; document.body.classList.remove('space-held'); document.body.classList.remove('is-panning-ws'); }});

            const triggerWorker = debounce(() => processImage(), 100);

            window.addEventListener('wheel', e => {
                if (e.target.closest('#sidebar')) return;
                e.preventDefault();
                if (e.target.closest('#canvasWrapper') && !e.altKey && !keys.Space && !state.isWsPanning) {
                    const delta = e.deltaY * -0.001;
                    state.imgZoom = Math.max(1, Math.min(5, state.imgZoom + delta));
                    els.zoomSlider.value = state.imgZoom;
                    updateUIValues();
                    updatePreviewLayer();
                    triggerWorker(); 
                } else {
                    const delta = e.deltaY * -0.001;
                    state.wsZoom = Math.max(0.05, Math.min(5, state.wsZoom + delta));
                    updateWorkspaceTransform();
                }
            }, { passive: false });

            window.addEventListener('mousedown', e => {
                if (e.target.closest('#sidebar') || e.target.closest('#mobileSettingsToggle')) return;
                if (!state.image) return;
                
                if (e.button === 2) {
                    state.isWsPanning = true;
                    state.isDragging = true;
                    document.body.classList.add('is-panning-ws');
                    state.lastMouse = { x: e.clientX, y: e.clientY };
                    return;
                }

                state.isDragging = true;
                state.lastMouse = { x: e.clientX, y: e.clientY };
                
                if (keys.Space || !e.target.closest('#canvasWrapper')) {
                    state.isWsPanning = true;
                    document.body.classList.add('is-panning-ws');
                } else {
                    state.isWsPanning = false;
                    els.canvasWrapper.classList.add('canvas-interacting');
                    els.emojiCanvas.style.opacity = '0.1'; 
                    updatePreviewLayer(true); 
                }
            });

            window.addEventListener('mousemove', e => {
                if (!state.isDragging) return;
                const dx = e.clientX - state.lastMouse.x;
                const dy = e.clientY - state.lastMouse.y;
                state.lastMouse = { x: e.clientX, y: e.clientY };

                if (state.isWsPanning) {
                    state.wsPan.x += dx;
                    state.wsPan.y += dy;
                    updateWorkspaceTransform();
                } else {
                    const targetW = els.bgCanvas.width;
                    const targetH = els.bgCanvas.height;
                    const srcW = state.image.width;
                    const srcH = state.image.height;
                    const crop = getCropGeometry(targetW, targetH);
                    
                    const maxX = Math.max(0, srcW - crop.sw); 
                    const maxY = Math.max(0, srcH - crop.sh);

                    const effDx = dx / state.wsZoom;
                    const effDy = dy / state.wsZoom;
                    
                    const ratioX = crop.sw / targetW; 
                    const ratioY = crop.sh / targetH;

                    const moveSrcX = effDx * ratioX;
                    const moveSrcY = effDy * ratioY;

                    if (maxX > 0) {
                        const pctChangeX = (moveSrcX / maxX) * 100;
                        state.imgPan.x = Math.max(0, Math.min(100, state.imgPan.x - pctChangeX));
                    }
                    if (maxY > 0) {
                        const pctChangeY = (moveSrcY / maxY) * 100;
                        state.imgPan.y = Math.max(0, Math.min(100, state.imgPan.y - pctChangeY));
                    }
                    
                    updatePreviewLayer(true);
                    setStatus('Panning...', true);
                }
            });

            window.addEventListener('mouseup', () => {
                if (!state.isDragging) return;
                state.isDragging = false;
                state.isWsPanning = false;
                document.body.classList.remove('is-panning-ws');
                els.canvasWrapper.classList.remove('canvas-interacting');
                
                if (state.image) {
                    els.emojiCanvas.style.opacity = '1';
                    triggerWorker();
                }
            });

            // Fix: Safety check for lost mouseups (e.g. dragging cursor out of window)
            // This ensures state.isDragging doesn't get stuck at 'true'
            window.addEventListener('mouseenter', (e) => {
                if (e.buttons === 0 && state.isDragging) {
                    state.isDragging = false;
                    state.isWsPanning = false;
                    document.body.classList.remove('is-panning-ws');
                    els.canvasWrapper.classList.remove('canvas-interacting');
                    if (state.image) {
                        els.emojiCanvas.style.opacity = '1';
                        triggerWorker();
                    }
                }
            });
        }

        function updateWorkspaceTransform() {
            // Because we are using left:50% top:50%, we must offset by -50% -50% to center the element on its origin.
            // THEN we apply the user's pan/zoom.
            els.canvasWrapper.style.transform = `translate(-50%, -50%) translate(${state.wsPan.x}px, ${state.wsPan.y}px) scale(${state.wsZoom})`;
        }

        // --- 8. Core Processing ---

        function getCropGeometry(targetW, targetH) {
            const outputRatio = targetW / targetH;
            const srcW = state.image.width;
            const srcH = state.image.height;
            let baseSw, baseSh;
            if (srcW / srcH > outputRatio) { baseSh = srcH; baseSw = srcH * outputRatio; } 
            else { baseSw = srcW; baseSh = srcW / outputRatio; }
            
            const sw = baseSw / state.imgZoom;
            const sh = baseSh / state.imgZoom;
            const maxX = srcW - sw; const maxY = srcH - sh;
            const sx = maxX * (state.imgPan.x / 100);
            const sy = maxY * (state.imgPan.y / 100);
            return { sx, sy, sw, sh };
        }

        function updatePreviewLayer(forceVisible = false) {
            if (!state.image) return;
            const w = els.bgCanvas.width;
            const h = els.bgCanvas.height;
            if(w===0 || h===0) return;

            const ctx = els.bgCanvas.getContext('2d');
            ctx.clearRect(0, 0, w, h);
            
            if (!state.settings.isTransparent) {
                ctx.fillStyle = state.settings.bgColor;
                ctx.fillRect(0, 0, w, h);
            }

            if (state.settings.onionSkin || forceVisible) {
                ctx.globalAlpha = (state.settings.onionSkin && !forceVisible) ? 0.4 : 1.0; 
                ctx.filter = getCSSFilterString();
                const crop = getCropGeometry(w, h);
                ctx.drawImage(state.image, crop.sx, crop.sy, crop.sw, crop.sh, 0, 0, w, h);
                ctx.filter = 'none';
                ctx.globalAlpha = 1.0;
            }
        }

        function processImage() {
            if (!state.image) return;
            
            state.currentJobId++;
            const thisJobId = state.currentJobId;

            let targetW = Math.max(10, state.settings.resolution);
            let targetH;
            if (state.settings.aspectRatio !== 0) targetH = targetW / state.settings.aspectRatio;
            else targetH = targetW * (state.image.height / state.image.width);
            targetW = Math.round(targetW); targetH = Math.round(targetH);

            setStatus(`Processing ${targetW}x${targetH}`, true);

            const procCanvas = document.createElement('canvas');
            procCanvas.width = targetW; procCanvas.height = targetH;
            const ctx = procCanvas.getContext('2d');
            
            ctx.clearRect(0, 0, targetW, targetH);
            ctx.filter = getCSSFilterString();
            const crop = getCropGeometry(targetW, targetH);
            ctx.drawImage(state.image, crop.sx, crop.sy, crop.sw, crop.sh, 0, 0, targetW, targetH);
            const imageData = ctx.getImageData(0, 0, targetW, targetH);

            state.worker.postMessage({
                jobId: thisJobId,
                imageData: imageData.data.buffer,
                emojiDB: state.emojiDB,
                cellSize: state.settings.cellSize,
                spacing: state.settings.spacing,
                chaos: state.settings.chaos,
                width: targetW, height: targetH
            }, [imageData.data.buffer]);
        }

        function handleWorkerMessage(e) {
            if (e.data.jobId !== state.currentJobId) return;
            
            // Fix: Removed 'if (state.isDragging) return;' 
            // We now allow the completion handler to run even if dragging. 
            // This prevents the "Processing" label from getting stuck forever.
            // Since opacity is lowered during drag, visual tearing is minimal.

            if (e.data.type === 'progress') {
                const { percent } = e.data;
                setStatus(`Rendering ${percent}%`, true);
            } 
            else if (e.data.type === 'complete') {
                const { results, meta } = e.data;
                
                // Set fixed dimensions to prevent CSS squishing
                els.bgCanvas.width = meta.width; 
                els.bgCanvas.height = meta.height;
                els.emojiCanvas.width = meta.width; 
                els.emojiCanvas.height = meta.height;

                const ctx = els.emojiCanvas.getContext('2d');
                const { cellSize } = state.settings;
                ctx.clearRect(0, 0, meta.width, meta.height);
                ctx.font = `${cellSize}px sans-serif`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                
                for(let i=0; i<results.length; i++) {
                    const p = results[i];
                    ctx.fillText(p.char, p.x + cellSize/2, p.y + cellSize/2 + (cellSize*0.1));
                }

                els.emojiCanvas.style.opacity = '1';
                updatePreviewLayer(); 
                setStatus('Ready', false);
            }
        }

        function getCSSFilterString() {
            // Base adjustments from sliders
            let fs = `brightness(${state.settings.brightness}%) contrast(${state.settings.contrast}%) saturate(${state.settings.saturation}%)`;
            
            const p = state.settings.filter;
            
            // Standard
            if (p === 'grayscale') fs += ' grayscale(100%)';
            else if (p === 'sepia') fs += ' sepia(100%)';
            else if (p === 'invert') fs += ' invert(100%)';
            
            // Artistic
            else if (p === 'high_contrast') fs += ' contrast(150%)';
            else if (p === 'low_contrast') fs += ' contrast(70%) brightness(120%)';
            else if (p === 'vivid') fs += ' saturate(150%) contrast(110%)';
            else if (p === 'muted') fs += ' saturate(50%) brightness(110%)';
            else if (p === 'deepfry') fs += ' saturate(300%) contrast(200%) brightness(110%)';
            else if (p === 'polaroid') fs += ' contrast(90%) brightness(110%) sepia(20%) saturate(120%)';
            else if (p === 'kodak') fs += ' contrast(120%) saturate(130%) sepia(10%)';
            else if (p === 'vintage') fs += ' sepia(50%) contrast(80%) brightness(110%)';
            else if (p === 'cyberpunk') fs += ' hue-rotate(190deg) saturate(200%)';
            else if (p === 'noir') fs += ' grayscale(100%) contrast(150%) brightness(90%)';
            
            // Retro / Instagram-style (Added missing ones)
            else if (p === '1977') fs += ' sepia(0.5) hue-rotate(-30deg) saturate(140%)';
            else if (p === 'willow') fs += ' grayscale(0.5) contrast(85%) brightness(120%) sepia(20%)';
            else if (p === 'lofi') fs += ' saturate(110%) contrast(150%)';
            else if (p === 'xpro2') fs += ' sepia(30%) hue-rotate(-20deg) contrast(125%) saturate(125%)';
            else if (p === 'inkwell') fs += ' sepia(30%) contrast(110%) brightness(110%) grayscale(100%)';
            else if (p === 'nashville') fs += ' sepia(20%) contrast(120%) brightness(105%) saturate(120%)';
            else if (p === 'toaster') fs += ' sepia(25%) contrast(150%) brightness(95%)';
            else if (p === 'gotham') fs += ' grayscale(100%) sepia(20%) contrast(130%) brightness(80%)';
            
            return fs;
        }

        function handleDrop(e) { e.preventDefault(); if (e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]); }
        function loadFile(file) {
            if (!file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.image = img;
                    state.settings.resolution = Math.min(img.width, 2500); // Sensible default
                    els.resolution.value = state.settings.resolution;
                    els.resolutionVal.innerText = state.settings.resolution + 'px';
                    
                    els.emptyState.style.opacity = '0';
                    setTimeout(() => els.emptyState.style.display = 'none', 300);
                    els.canvasWrapper.style.display = 'block';
                    
                    fitWorkspace();
                    updateSettings();
                    processImage();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function exportImage() {
            if (!state.image) return;
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = els.emojiCanvas.width;
            exportCanvas.height = els.emojiCanvas.height;
            const ctx = exportCanvas.getContext('2d');
            
            if (!state.settings.isTransparent) { 
                ctx.fillStyle = state.settings.bgColor; 
                ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height); 
            }

            if (state.settings.onionSkin) {
                ctx.filter = getCSSFilterString();
                const crop = getCropGeometry(exportCanvas.width, exportCanvas.height);
                ctx.globalAlpha = 0.4;
                ctx.drawImage(state.image, crop.sx, crop.sy, crop.sw, crop.sh, 0, 0, exportCanvas.width, exportCanvas.height);
                ctx.globalAlpha = 1.0;
                ctx.filter = 'none';
            }
            ctx.drawImage(els.emojiCanvas, 0, 0);
            const link = document.createElement('a');
            link.download = `emoji-mosaic-${Date.now()}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
        }

        function updateUIValues() {
            els.contrastVal.innerText = els.contrast.value + '%';
            els.brightnessVal.innerText = els.brightness.value + '%';
            els.saturationVal.innerText = els.saturation.value + '%';
            els.cellSizeVal.innerText = els.cellSize.value + 'px';
            els.spacingVal.innerText = els.spacing.value + 'px';
            els.chaosVal.innerText = els.chaos.value;
            els.resolutionVal.innerText = els.resolution.value + 'px';
            els.zoomDisplay.innerText = state.imgZoom.toFixed(1) + 'x';
        }

        function updateToggles() {
            if (state.settings.onionSkin) { els.onionKnob.classList.add('translate-x-4'); els.onionToggle.classList.replace('bg-zinc-700', 'bg-indigo-600'); } 
            else { els.onionKnob.classList.remove('translate-x-4'); els.onionToggle.classList.replace('bg-indigo-600', 'bg-zinc-700'); }
        }

        function updateSettings() {
            state.settings = {
                aspectRatio: parseFloat(els.aspectRatio.value),
                filter: els.filterPreset.value,
                contrast: parseInt(els.contrast.value),
                brightness: parseInt(els.brightness.value),
                saturation: parseInt(els.saturation.value),
                resolution: parseInt(els.resolution.value),
                cellSize: parseInt(els.cellSize.value),
                spacing: parseInt(els.spacing.value),
                chaos: parseInt(els.chaos.value),
                onionSkin: state.settings.onionSkin,
                bgColor: state.settings.bgColor,
                isTransparent: state.settings.isTransparent
            };
        }

        function debounce(fn, delay) {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn(...args), delay); }
        }

        init();
    </script>
</body>
</html>